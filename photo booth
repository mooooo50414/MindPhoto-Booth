<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindPhoto Booth - ‡∏ï‡∏π‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 40px;
            max-width: 1400px;
            width: 95%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-layout {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .camera-section {
            flex: 1;
            text-align: center;
        }

        #video, #editCanvas {
            width: 100%;
            max-width: 800px;
            height: 600px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            background: #000;
        }

        .camera-placeholder {
            width: 100%;
            max-width: 800px;
            height: 600px;
            border-radius: 15px;
            background: linear-gradient(135deg, #333 0%, #555 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .permission-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .permission-content h2 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .permission-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .permission-content .steps {
            text-align: left;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .camera-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .countdown {
            font-size: 120px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.8), 0 0 60px rgba(118, 75, 162, 0.8);
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .side-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 15px;
        }

        .filter-section h3 {
            margin-bottom: 10px;
            color: #764ba2;
            font-size: 1.2em;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 15px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #764ba2;
            color: white;
        }

        .filter-btn.active {
            background: #764ba2;
            color: white;
        }

        .photo-strip {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .photo-strip img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-strip img:hover {
            transform: scale(1.05);
        }

        .photo-strip img.selected {
            border: 3px solid #764ba2;
        }

        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        .flash-effect.active {
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .camera-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10;
            display: none;
        }

        .photo-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(118, 75, 162, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            z-index: 10;
            display: none;
        }

        .photo-preview {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 120px;
            height: 90px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 15;
            display: none;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .start-screen {
            text-align: center;
            padding: 50px 0;
        }

        .start-screen h2 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .start-screen p {
            margin-bottom: 30px;
            color: #666;
        }

        .edit-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 15px;
            display: none;
        }

        .edit-section h3 {
            margin-bottom: 10px;
            color: #764ba2;
            font-size: 1.2em;
            text-align: center;
        }

        .edit-tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .tool-btn {
            padding: 8px 15px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:hover {
            background: #764ba2;
            color: white;
        }

        .tool-btn.active {
            background: #764ba2;
            color: white;
        }

        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }
            
            .side-panel {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
            }
            
            #video, #editCanvas, .camera-placeholder {
                height: 400px;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            #video, #editCanvas, .camera-placeholder {
                height: 300px;
            }
            
            .filter-buttons, .edit-tools {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ MindPhoto Booth</h1>
        
        <div class="permission-modal" id="permissionModal">
            <div class="permission-content">
                <h2>üì∑ ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</h2>
                <p>MindPhoto Booth ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
                <div class="steps">
                    <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</strong></p>
                    <p>1. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å "Allow" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"</p>
                    <p>2. ‡∏´‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö URL</p>
                    <p>3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏°‡∏≠" ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤</p>
                </div>
                <p>üîí ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 100%</p>
                <button onclick="requestCameraPermission()">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
        </div>
        
        <div class="start-screen" id="startScreen">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà MindPhoto Booth!</h2>
            <p>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πÑ‡∏ï‡∏•‡πå photo strip ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô</p>
            <button onclick="showPermissionModal()">üé¨ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
        </div>

        <div class="main-layout" id="mainLayout" style="display: none;">
            <div class="camera-section" id="cameraSection">
                <div class="camera-container">
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <div>
                            <div style="font-size: 48px; margin-bottom: 20px;">üì∑</div>
                            <div>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
                            <div style="font-size: 14px; margin-top: 10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å "Allow" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏°</div>
                        </div>
                    </div>
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="editCanvas"></canvas>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="countdown" id="countdown"></div>
                    <div class="flash-effect" id="flashEffect"></div>
                    <div class="camera-info" id="cameraInfo">üì∏ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
                    <div class="photo-counter" id="photoCounter">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1/4</div>
                    <div class="photo-preview" id="photoPreview">
                        <img id="previewImg" alt="Last photo">
                    </div>
                </div>
                
                <div class="controls" id="controls">
                    <button onclick="startPhotoSession()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (4 ‡∏£‡∏π‡∏õ)</button>
                    <button onclick="takeSinglePhoto()">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</button>
                    <button onclick="switchCamera()" id="switchCameraBtn">üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button onclick="resetSession()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>

            <div class="side-panel">
                <div class="filter-section" id="filterSection">
                    <h3>üé® ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilter('none')">‡∏õ‡∏Å‡∏ï‡∏¥</button>
                        <button class="filter-btn" onclick="setFilter('grayscale')">‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥</button>
                        <button class="filter-btn" onclick="setFilter('sepia')">‡∏ã‡∏µ‡πÄ‡∏õ‡∏µ‡∏¢</button>
                        <button class="filter-btn" onclick="setFilter('vintage')">‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</button>
                        <button class="filter-btn" onclick="setFilter('contrast')">‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå</button>
                        <button class="filter-btn" onclick="setFilter('blur')">‡πÄ‡∏ö‡∏•‡∏≠</button>
                        <button class="filter-btn" onclick="setFilter('rainbow')">‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏î‡πÉ‡∏™</button>
                    </div>
                </div>

                <div class="photo-strip" id="photoStrip" style="display: none;">
                    <img id="photo1" alt="Photo 1" onclick="selectPhotoForEdit(0)">
                    <img id="photo2" alt="Photo 2" onclick="selectPhotoForEdit(1)">
                    <img id="photo3" alt="Photo 3" onclick="selectPhotoForEdit(2)">
                    <img id="photo4" alt="Photo 4" onclick="selectPhotoForEdit(3)">
                </div>

                <div class="edit-section" id="editSection">
                    <h3>‚úèÔ∏è ‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏π‡∏õ</h3>
                    <div class="edit-tools">
                        <button class="tool-btn" onclick="setEditMode('adjust')">üéöÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤</button>
                        <button class="tool-btn" onclick="setEditMode('draw')">‚úèÔ∏è ‡∏ß‡∏≤‡∏î</button>
                        <button class="tool-btn" onclick="setEditMode('text')">üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                        <button class="tool-btn" onclick="setEditMode('sticker')">‚≠ê ‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</button>
                    </div>
                    
                    <div id="editToolsContent"></div>
                    
                    <div class="controls" style="margin-top: 10px;">
                        <button onclick="saveCurrentEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="downloadPhotoStrip()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let editCanvas = document.getElementById('editCanvas');
        let ctx = canvas.getContext('2d');
        let editCtx = editCanvas.getContext('2d');
        let photos = [];
        let originalPhotos = [];
        let currentFilter = 'none';
        let stream = null;
        let currentEditMode = null;
        let selectedPhotoIndex = -1;
        let currentFacingMode = 'user';
        let permissionRequested = false;

        function showPermissionModal() {
            document.getElementById('permissionModal').style.display = 'flex';
        }

        async function requestCameraPermission() {
            document.getElementById('permissionModal').style.display = 'none';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainLayout').style.display = 'flex';
            
            const placeholder = document.getElementById('cameraPlaceholder');
            const cameraInfo = document.getElementById('cameraInfo');
            
            try {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                cameraInfo.textContent = 'üé• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
                cameraInfo.style.display = 'block';
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö browser support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á');
                }
                
                // ‡∏Ç‡∏≠ permission
                console.log('Requesting camera permission...');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: currentFacingMode
                    },
                    audio: false
                });
                
                console.log('Got stream:', stream);
                
                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á
                video.srcObject = stream;
                
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ metadata ‡πÇ‡∏´‡∏•‡∏î
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('Video metadata loaded');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        editCanvas.width = video.videoWidth;
                        editCanvas.height = video.videoHeight;
                        resolve();
                    };
                    video.onerror = reject;
                });
                
                // ‡πÄ‡∏•‡πà‡∏ô video
                await video.play();
                console.log('Video playing');
                
                // ‡πÅ‡∏™‡∏î‡∏á video
                placeholder.style.display = 'none';
                video.style.display = 'block';
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
                await checkCameraDevices();
                
                cameraInfo.textContent = '‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                setTimeout(() => {
                    cameraInfo.style.display = 'none';
                }, 2000);
                
                permissionRequested = true;
                
            } catch (err) {
                console.error('Camera error:', err);
                handleCameraError(err);
            }
        }

        function handleCameraError(err) {
            const placeholder = document.getElementById('cameraPlaceholder');
            const cameraInfo = document.getElementById('cameraInfo');
            
            cameraInfo.style.display = 'none';
            
            let errorHTML = '<div><div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>';
            let alertMessage = '';
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                errorHTML += '<div>‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>';
                errorHTML += '<div style="font-size: 14px; margin-top: 10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>';
                alertMessage = '‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö URL\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏°‡∏≠"\n3. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ (F5)';
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                errorHTML += '<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>';
                alertMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n- ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                errorHTML += '<div>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>';
                alertMessage = '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏õ‡∏≠‡∏∑‡πà‡∏ô\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î:\n- Zoom, Teams, Skype\n- ‡πÅ‡∏≠‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
            } else {
                errorHTML += '<div>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
                alertMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
            }
            
            errorHTML += '</div>';
            placeholder.innerHTML = errorHTML;
            
            setTimeout(() => {
                alert(alertMessage);
                // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                document.getElementById('mainLayout').style.display = 'none';
                document.getElementById('startScreen').style.display = 'block';
            }, 500);
        }

        async function checkCameraDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log('Found cameras:', videoDevices.length);
                
                if (videoDevices.length <= 1) {
                    document.getElementById('switchCameraBtn').style.display = 'none';
                }
            } catch (err) {
                console.error('Error checking cameras:', err);
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filterValue = '';
            switch(filter) {
                case 'none':
                    filterValue = 'none';
                    break;
                case 'grayscale':
                    filterValue = 'grayscale(100%)';
                    break;
                case 'sepia':
                    filterValue = 'sepia(100%)';
                    break;
                case 'vintage':
                    filterValue = 'contrast(1.2) saturate(0.8) brightness(1.1) sepia(0.3)';
                    break;
                case 'contrast':
                    filterValue = 'contrast(1.5)';
                    break;
                case 'blur':
                    filterValue = 'blur(2px)';
                    break;
                case 'rainbow':
                    filterValue = 'saturate(2) hue-rotate(30deg)';
                    break;
            }
            video.style.filter = filterValue;
        }

        async function startPhotoSession() {
            if (!permissionRequested || !stream) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            photos = [];
            originalPhotos = [];
            document.getElementById('photoStrip').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoCounter').style.display = 'block';
            document.getElementById('cameraInfo').style.display = 'block';
            
            for (let i = 0; i < 4; i++) {
                document.getElementById('photoCounter').textContent = `‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${i + 1}/4`;
                document.getElementById('cameraInfo').textContent = 'üì∏ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...';
                await countdown(3);
                await takePhoto(i);
                await sleep(1000);
            }
            
            document.getElementById('photoCounter').style.display = 'none';
            document.getElementById('cameraInfo').style.display = 'none';
            showPhotoStrip();
        }

        async function takeSinglePhoto() {
            if (!permissionRequested || !stream) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            photos = [];
            originalPhotos = [];
            document.getElementById('photoPreview').style.display = 'none';
            
            await countdown(3);
            await takePhoto(0);
            
            await sleep(1000);
            selectedPhotoIndex = 0;
            showEditMode();
        }

        async function countdown(seconds) {
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';
            
            for (let i = seconds; i > 0; i--) {
                countdownEl.textContent = i;
                countdownEl.style.animation = 'none';
                setTimeout(() => {
                    countdownEl.style.animation = 'pulse 1s ease-in-out';
                }, 10);
                await sleep(1000);
            }
            
            countdownEl.textContent = 'üì∏';
            await sleep(300);
            countdownEl.style.display = 'none';
        }

        async function takePhoto(index) {
            ctx.filter = getCanvasFilter();
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/png');
            photos.push(dataUrl);
            originalPhotos.push(dataUrl);
            
            // Flash effect
            const flashEl = document.getElementById('flashEffect');
            flashEl.classList.add('active');
            setTimeout(() => {
                flashEl.classList.remove('active');
            }, 300);
            
            // Show preview
            const previewEl = document.getElementById('photoPreview');
            const previewImg = document.getElementById('previewImg');
            previewImg.src = dataUrl;
            previewEl.style.display = 'block';
            
            // Camera sound
            playShutterSound();
        }

        function getCanvasFilter() {
            switch(currentFilter) {
                case 'grayscale':
                    return 'grayscale(100%)';
                case 'sepia':
                    return 'sepia(100%)';
                case 'vintage':
                    return 'contrast(1.2) saturate(0.8) brightness(1.1) sepia(0.3)';
                case 'contrast':
                    return 'contrast(1.5)';
                case 'blur':
                    return 'blur(2px)';
                case 'rainbow':
                    return 'saturate(2) hue-rotate(30deg)';
                default:
                    return 'none';
            }
        }

        function showPhotoStrip() {
            document.getElementById('photoStrip').style.display = 'grid';
            
            photos.forEach((photo, index) => {
                if (document.getElementById(`photo${index + 1}`)) {
                    document.getElementById(`photo${index + 1}`).src = photo;
                }
            });
        }

        function selectPhotoForEdit(index) {
            selectedPhotoIndex = index;
            document.querySelectorAll('.photo-strip img').forEach((img, i) => {
                img.classList.toggle('selected', i === index);
            });
            showEditMode();
        }

        function showEditMode() {
            if (selectedPhotoIndex === -1 || !photos[selectedPhotoIndex]) return;
            
            video.style.display = 'none';
            editCanvas.style.display = 'block';
            document.getElementById('cameraPlaceholder').style.display = 'none';
            
            const img = new Image();
            img.onload = () => {
                editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
                editCtx.drawImage(img, 0, 0, editCanvas.width, editCanvas.height);
            };
            img.src = photos[selectedPhotoIndex];
        }

        function setEditMode(mode) {
            currentEditMode = mode;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const contentEl = document.getElementById('editToolsContent');
            contentEl.innerHTML = '';
            
            switch(mode) {
                case 'adjust':
                    contentEl.innerHTML = '<p style="text-align: center; color: #666;">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏û - ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>';
                    break;
                case 'draw':
                    contentEl.innerHTML = '<p style="text-align: center; color: #666;">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ß‡∏≤‡∏î - ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>';
                    break;
                case 'text':
                    contentEl.innerHTML = '<p style="text-align: center; color: #666;">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° - ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>';
                    break;
                case 'sticker':
                    contentEl.innerHTML = '<p style="text-align: center; color: #666;">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå - ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>';
                    break;
            }
        }

        async function switchCamera() {
            if (!stream) return;
            
            const placeholder = document.getElementById('cameraPlaceholder');
            const cameraInfo = document.getElementById('cameraInfo');
            
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.innerHTML = '<div><div style="font-size: 48px; margin-bottom: 20px;">üîÑ</div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div></div>';
            
            stream.getTracks().forEach(track => track.stop());
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: currentFacingMode
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                await video.play();
                
                placeholder.style.display = 'none';
                video.style.display = 'block';
                
                cameraInfo.textContent = currentFacingMode === 'user' ? 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤' : 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á';
                cameraInfo.style.display = 'block';
                setTimeout(() => {
                    cameraInfo.style.display = 'none';
                }, 2000);
                
            } catch (err) {
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
                await requestCameraPermission();
            }
        }

        function saveCurrentEdit() {
            if (selectedPhotoIndex === -1) return;
            
            photos[selectedPhotoIndex] = editCanvas.toDataURL('image/png');
            document.getElementById(`photo${selectedPhotoIndex + 1}`).src = photos[selectedPhotoIndex];
            
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
        }

        async function downloadPhotoStrip() {
            const stripCanvas = document.createElement('canvas');
            const stripCtx = stripCanvas.getContext('2d');
            
            // ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô 2x2
            stripCanvas.width = 800;
            stripCanvas.height = 400;
            
            stripCtx.fillStyle = 'white';
            stripCtx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);
            
            const positions = [
                {x: 20, y: 20},
                {x: 410, y: 20},
                {x: 20, y: 210},
                {x: 410, y: 210}
            ];
            
            for (let i = 0; i < Math.min(photos.length, 4); i++) {
                const img = new Image();
                img.src = photos[i];
                await new Promise(resolve => {
                    img.onload = () => {
                        stripCtx.drawImage(img, positions[i].x, positions[i].y, 370, 170);
                        resolve();
                    };
                });
            }
            
            stripCtx.fillStyle = '#333';
            stripCtx.font = 'bold 24px Arial';
            stripCtx.textAlign = 'center';
            stripCtx.fillText('MindPhoto Booth', 400, 350);
            
            const date = new Date().toLocaleDateString('th-TH');
            stripCtx.font = '16px Arial';
            stripCtx.fillText(date, 400, 380);
            
            const link = document.createElement('a');
            link.download = `mindphoto-booth-${Date.now()}.png`;
            link.href = stripCanvas.toDataURL();
            link.click();
        }

        function resetSession() {
            photos = [];
            originalPhotos = [];
            selectedPhotoIndex = -1;
            
            document.getElementById('photoStrip').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'none';
            video.style.display = 'block';
            editCanvas.style.display = 'none';
        }

        function playShutterSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCxuxO3Yk0ULH2i96+OZURE');
            audio.volume = 0.3;
            audio.play().catch(() => {});
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î stream ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö HTTPS
        window.addEventListener('load', () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                const warningEl = document.createElement('div');
                warningEl.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; text-align: center; padding: 10px; z-index: 9999;';
                warningEl.innerHTML = '‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ HTTPS - ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ https:// ‡∏´‡∏£‡∏∑‡∏≠ localhost';
                document.body.appendChild(warningEl);
            }
        });
    </script>
</body>
</html>
